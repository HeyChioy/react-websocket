{"version":3,"sources":["../src/WebSocketRC.js"],"names":["tryToParseJson","str","JSON","parse","e","WebSocketRC","props","handleMessage","data","json","action","actionKey","handler","actionMap","onJson","onMessage","closeOldSocket","ws","readyState","WebSocket","CONNECTING","shouldClose","close","url","protocol","retryTimes","state","initWebSocket","onclose","autoReconnect","maxRetryTimes","onClose","onRetry","setTimeout","retryDelay","onerror","onError","onmessage","decorator","send","sendData","constructor","String","stringify","onopen","onCreate","display","Component","propTypes","string","isRequired","func","object","bool","number","defaultProps"],"mappings":"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","file":"WebSocketRC.js","sourcesContent":["import React from 'react';\nimport PropTypes from 'prop-types';\n\n\nconst tryToParseJson = (str) => {\n  try {\n    return JSON.parse(str)\n  } catch (e) {}\n}\n\nclass WebSocketRC extends React.Component {\n  constructor(props) {\n    super(props);\n    const { url, protocol } = props; // Config\n    const { actionKey = 'SYS_ACTION', actionMap = {} } = props;\n    this.shouldClose = false;\n    this.retryTimes = 1;\n    this.state = {\n      // Config\n      url,\n      protocol,\n      actionKey,\n      actionMap,\n    };\n  }\n  handleMessage = ({ data }) => {\n    const json = tryToParseJson(data)\n    if (json) {\n      const action = json[this.props.actionKey];\n      const handler = this.props.actionMap[action];\n      if (action && handler) {\n        handler(json);\n      } else {\n        this.props.onJson(json);\n      }\n    } else {\n      this.props.onMessage(data);\n    }\n  };\n  componentWillMount() {\n    this.initWebSocket();\n  }\n  componentWillUnmount() {\n    this.shouldClose = true;\n    this.ws.close();\n  }\n  closeOldSocket = () => {\n    if (this.ws && (this.ws.readyState === WebSocket.CONNECTING)) {\n      this.shouldClose = true;\n      this.ws.close();\n    }\n  };\n  initWebSocket() {\n    this.closeOldSocket();\n    const ws = new WebSocket(this.props.url, this.props.protocol);\n    ws.onclose = () => {\n      if (!this.props.autoReconnect || // needn't reconnect\n        this.shouldClose || // really want to close\n        this.retryTimes++ > ( this.props.maxRetryTimes)) {\n        this.props.onClose();\n        return;\n      }\n      this.props.onRetry();\n      setTimeout(() => {\n        this.initWebSocket();\n      }, this.props.retryDelay);\n    };\n    ws.onerror = (e) => {\n      this.props.onError(e);\n      ws.close();\n    };\n    ws.onmessage = this.handleMessage;\n    const decorator = {\n      send(data) {\n        const sendData = data.constructor === String ?\n          data: JSON.stringify(data);\n        ws.send(sendData);\n      }\n    };\n    ws.onopen = () => {\n      this.retryTimes = 1;\n      this.ws = ws;\n      this.props.onCreate(decorator, ws);\n    }\n  }\n  render() {\n    return (\n      <span style={{ display: 'none' }}>WebSocket React Component by KyuuSeiryuu.</span>\n    );\n  }\n}\n\nWebSocketRC.propTypes = {\n  url: PropTypes.string.isRequired,\n  protocol: PropTypes.string,\n  onMessage: PropTypes.func.isRequired,\n  onJson: PropTypes.func,\n  onCreate: PropTypes.func,\n  onClose: PropTypes.func,\n  onError: PropTypes.func,\n  onRetry: PropTypes.func,\n  actionMap: PropTypes.object,\n  actionKey: PropTypes.string,\n  autoReconnect: PropTypes.bool,\n  maxRetryTimes: PropTypes.number,\n  retryDelay: PropTypes.number,\n};\n\nWebSocketRC.defaultProps = {\n  onCreate: () => {},\n  onClose: () => {},\n  onRetry: () => {},\n  onError: () => {},\n  autoReconnect: false,\n  maxRetryTimes: 3,\n  retryDelay: 3000,\n  actionMap: {},\n  onJson: () => {}\n}\n\nexport default WebSocketRC;\n"]}